{% extends 'base.html' %}
{% block content %}
<div class="container-fluid">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h3 class="fw-bold mb-0">Týždenný prehľad</h3>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addRecordModal">
      <i class="fa fa-plus me-2"></i> Pridať záznam
    </button>
  </div>

  <div class="row g-4">
    <!-- Výkon podľa dní -->
    <div class="col-lg-8">
      <div class="card p-4 shadow-sm">
        <h5 class="fw-semibold mb-3">Hodiny zo záznamov</h5>
        <canvas id="hoursChart"
          data-labels='{{ chart_labels|tojson }}'
          data-values='{{ chart_values|tojson }}'></canvas>
      </div>
    </div>

    <!-- Výkon podľa projektu -->
    <div class="col-lg-4">
      <div class="card p-4 shadow-sm">
        <h5 class="fw-semibold mb-3">Výkon podľa projektu</h5>
        <canvas id="projectChart"
          data-labels='{{ project_labels|tojson }}'
          data-values='{{ project_values|tojson }}'></canvas>
      </div>
    </div>
  </div>

  <!-- Súhrny -->
  <div class="row mt-4 g-4">
    <div class="col-md-3">
      <div class="card stat-card">
        <h6 class="text-muted">Celkový výkon</h6>
        <h3>{{ "%.1f"|format(total) }}</h3>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card stat-card">
        <h6 class="text-muted">Počet projektov</h6>
        <h3>{{ project_count }}</h3>
      </div>
    </div>
  </div>
</div>

<!-- MODAL NA PRIDANIE ZÁZNAMU -->
<div class="modal fade" id="addRecordModal" tabindex="-1" aria-labelledby="addRecordModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="POST" action="{{ url_for('add_record') }}">
        <div class="modal-header">
          <h5 class="modal-title" id="addRecordModalLabel">Pridať záznam</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Zavrieť"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Projekt</label>
            <select name="project_id" class="form-select" required>
              {% for p in projects %}
              <option value="{{ p.id }}">{{ p.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Dátum</label>
            <input type="date" name="date" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Množstvo (hodiny / m²)</label>
            <input type="number" name="amount" step="0.1" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Poznámka</label>
            <input type="text" name="note" class="form-control">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Zrušiť</button>
          <button type="submit" class="btn btn-primary">Uložiť</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const ctx = document.getElementById("hoursChart");
  if (ctx) {
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: JSON.parse(ctx.dataset.labels),
        datasets: [{
          label: 'Výkon',
          data: JSON.parse(ctx.dataset.values),
          backgroundColor: 'rgba(0,191,166,0.7)',
          borderRadius: 6
        }]
      },
      options: {
        plugins: { legend: { display: false } },
        scales: { y: { beginAtZero: true } }
      }
    });
  }

  const proj = document.getElementById("projectChart");
  if (proj) {
    new Chart(proj, {
      type: 'doughnut',
      data: {
        labels: JSON.parse(proj.dataset.labels),
        datasets: [{
          data: JSON.parse(proj.dataset.values),
          backgroundColor: ['#00bfa6', '#009d8b', '#f4b400', '#ff7043', '#42a5f5']
        }]
      },
      options: { plugins: { legend: { position: 'bottom' } } }
    });
  }
});
</script>
{% endblock %}
