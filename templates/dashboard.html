{% extends 'base.html' %}
{% block content %}

<div class="container-fluid">
  <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap">
    <h3 class="fw-bold mb-0">Dashboard</h3>

    <!-- üîπ Filter -->
    <form method="get" class="d-flex gap-2 flex-wrap align-items-center">
      {% if user.is_admin %}
      <select name="user_id" class="form-select">
        <option value="">üë§ V≈°etci pou≈æ√≠vatelia</option>
        {% for u in users %}
          <option value="{{ u.id }}" {% if selected_user == u.id %}selected{% endif %}>{{ u.name }}</option>
        {% endfor %}
      </select>
      {% endif %}

      <select name="project_id" class="form-select">
        <option value="">üìÅ V≈°etky projekty</option>
        {% for p in projects %}
          <option value="{{ p.id }}" {% if selected_project == p.id %}selected{% endif %}>{{ p.name }}</option>
        {% endfor %}
      </select>

      <button type="submit" class="btn btn-outline-primary">
        <i class="fa fa-filter me-1"></i> Filtrova≈•
      </button>

      <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary">
        <i class="fa fa-rotate-left me-1"></i> Reset
      </a>
    </form>

    <!-- üîπ Export + Prida≈• -->
    <div class="d-flex gap-2 mt-2 mt-md-0">
      <a href="{{ url_for('export_pdf', user_id=selected_user, project_id=selected_project) }}" 
         class="btn btn-outline-danger">
        <i class="fa fa-file-pdf me-1"></i> Exportova≈• PDF
      </a>

      <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addRecordModal">
        <i class="fa fa-plus me-1"></i> Prida≈• z√°znam
      </button>
    </div>
  </div>

  <!-- üîπ ≈†tatistiky -->
  <div class="row g-3 mb-4">
    <div class="col-md-3 col-6">
      <div class="card stat-card shadow-sm">
        <h6 class="text-muted mb-1">Celkov√Ω v√Ωkon</h6>
        <h2 class="fw-bold text-primary mb-0">{{ "%.2f"|format(total) }}</h2>
        <small class="text-muted">hod√≠n / m¬≤</small>
      </div>
    </div>
    <div class="col-md-3 col-6">
      <div class="card stat-card shadow-sm">
        <h6 class="text-muted mb-1">Poƒçet projektov</h6>
        <h2 class="fw-bold text-primary mb-0">{{ project_count }}</h2>
      </div>
    </div>
  </div>

  <!-- üîπ Sekcia grafov -->
  <div class="row g-4 mb-5">
    <div class="col-lg-6 col-md-12">
      <div class="card shadow-sm p-4 h-100">
        <div class="d-flex align-items-center mb-3">
          <i class="fa fa-chart-line text-primary me-2"></i>
          <h6 class="fw-semibold mb-0">V√Ωkon podƒæa d√°tumu</h6>
        </div>
        <div style="height: 280px;">
          <canvas id="hoursChart"
            data-labels='{{ chart_labels|tojson }}'
            data-values='{{ chart_values|tojson }}'></canvas>
        </div>
      </div>
    </div>

    <div class="col-lg-6 col-md-12">
      <div class="card shadow-sm p-4 h-100 text-center">
        <div class="d-flex align-items-center justify-content-center mb-3">
          <i class="fa fa-chart-pie text-primary me-2"></i>
          <h6 class="fw-semibold mb-0">V√Ωkon podƒæa projektu</h6>
        </div>
        <div class="d-flex justify-content-center" style="height: 260px;">
          <canvas id="projectChart"
            data-labels='{{ project_labels|tojson }}'
            data-values='{{ project_values|tojson }}'
            style="max-width: 80%; max-height: 250px;"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- üîπ Zoznam z√°znamov -->
  <div class="card p-4 shadow-sm">
    <h5 class="fw-semibold mb-3">Z√°znamy</h5>

    {% if records %}
    <div class="table-responsive">
      <table class="table table-hover align-middle">
        <thead class="table-light">
          <tr>
            <th>D√°tum</th>
            <th>Projekt</th>
            {% if user.is_admin %}
            <th>Pou≈æ√≠vateƒæ</th>
            {% endif %}
            <th>Mno≈æstvo</th>
            <th>Jednotka</th>
            <th>Pozn√°mka</th>
            {% if user.is_admin %}
            <th>Akcia</th>
            {% endif %}
          </tr>
        </thead>
        <tbody>
          {% for r in records %}
          <tr>
            <td>{{ r.date }}</td>
            <td>{{ r.project.name if r.project else '‚Äî' }}</td>
            {% if user.is_admin %}
            <td>{{ r.user.name if r.user else '‚Äî' }}</td>
            {% endif %}
            <td>{{ "%.2f"|format(r.amount) }}</td>
            <td>{{ r.unit_type or '' }}</td>
            <td>{{ r.note or '' }}</td>
            {% if user.is_admin %}
            <td>
              <form method="POST" action="{{ url_for('delete_record', id=r.id) }}" 
                    onsubmit="return confirm('Naozaj chce≈° zmaza≈• tento z√°znam?')">
                <button class="btn btn-sm btn-outline-danger">
                  <i class="fa fa-trash"></i>
                </button>
              </form>
            </td>
            {% endif %}
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <div class="alert alert-info mb-0">≈Ωiadne z√°znamy na zobrazenie.</div>
    {% endif %}
  </div>
</div>

<!-- üîπ MODAL ‚Äì Prida≈• z√°znam -->
<div class="modal fade" id="addRecordModal" tabindex="-1" aria-labelledby="addRecordModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="POST" action="{{ url_for('add_record') }}">
        <div class="modal-header">
          <h5 class="modal-title" id="addRecordModalLabel">Prida≈• z√°znam</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Zavrie≈•"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Projekt</label>
            <select name="project_id" class="form-select" required>
              {% for p in projects %}
              <option value="{{ p.id }}">{{ p.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">D√°tum</label>
            <input type="date" name="date" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Typ jednotky</label>
            <select name="unit_type" class="form-select" required>
              <option value="hodiny">Hodiny</option>
              <option value="m2">m¬≤</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Mno≈æstvo</label>
            <input type="number" name="amount" step="0.1" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Pozn√°mka</label>
            <input type="text" name="note" class="form-control">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Zru≈°i≈•</button>
          <button type="submit" class="btn btn-primary">Ulo≈æi≈•</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- üîπ Grafy JS -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  const hoursChartEl = document.getElementById('hoursChart');
  if (hoursChartEl) {
    const ctx = hoursChartEl.getContext('2d');
    const labels = JSON.parse(hoursChartEl.dataset.labels || "[]");
    const data = JSON.parse(hoursChartEl.dataset.values || "[]");
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'V√Ωkon (hodiny / m¬≤)',
          data: data,
          backgroundColor: 'rgba(0,191,166,0.8)',
          borderRadius: 6,
          barThickness: 30,
          maxBarThickness: 40
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
          y: {
            beginAtZero: true,
            grid: { color: 'rgba(220,220,220,0.3)' },
            ticks: { color: '#555' }
          },
          x: {
            grid: { display: false },
            ticks: { color: '#777' }
          }
        }
      }
    });
  }

  const projectChartEl = document.getElementById('projectChart');
  if (projectChartEl) {
    const ctx2 = projectChartEl.getContext('2d');
    const labels2 = JSON.parse(projectChartEl.dataset.labels || "[]");
    const data2 = JSON.parse(projectChartEl.dataset.values || "[]");
    new Chart(ctx2, {
      type: 'doughnut',
      data: {
        labels: labels2,
        datasets: [{
          data: data2,
          backgroundColor: [
            '#00bfa6', '#4fc3f7', '#81c784', '#ffd54f', '#9575cd', '#e57373'
          ],
          borderWidth: 2,
          borderColor: '#fff'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        cutout: '75%',
        layout: { padding: 10 },
        plugins: {
          legend: { 
            position: 'bottom', 
            labels: { boxWidth: 12, color: '#333', padding: 15 }
          },
          tooltip: {
            backgroundColor: '#fff',
            titleColor: '#000',
            bodyColor: '#000',
            borderColor: '#00bfa6',
            borderWidth: 1
          }
        }
      }
    });
  }
});
</script>

{% endblock %}
