{% extends 'base.html' %}
{% block content %}

<style>
/* üåà GLASSMORPHISM DASHBOARD WITH LIGHT/DARK TOGGLE */
:root {
  --bg-gradient: linear-gradient(135deg, #e3f2fd 0%, #f9fbff 100%);
  --glass-bg: rgba(255, 255, 255, 0.45);
  --glass-border: rgba(255, 255, 255, 0.25);
  --text-color: #222;
  --accent-color: #00bfa6;
  --shadow: rgba(0, 0, 0, 0.1);
  --card-hover: rgba(0, 0, 0, 0.15);
}

body.dark-mode {
  --bg-gradient: linear-gradient(135deg, #111827 0%, #1e293b 100%);
  --glass-bg: rgba(30, 41, 59, 0.45);
  --glass-border: rgba(255, 255, 255, 0.15);
  --text-color: #f1f5f9;
  --accent-color: #4fd1c5;
  --shadow: rgba(0, 0, 0, 0.5);
  --card-hover: rgba(255, 255, 255, 0.1);
}

body {
  background: var(--bg-gradient);
  color: var(--text-color);
  font-family: 'Inter', sans-serif;
  transition: background 0.5s ease, color 0.3s ease;
}

.glass-card {
  backdrop-filter: blur(16px);
  background: var(--glass-bg);
  border-radius: 20px;
  border: 1px solid var(--glass-border);
  box-shadow: 0 8px 32px var(--shadow);
  transition: all 0.3s ease;
}

.glass-card:hover {
  transform: translateY(-3px);
  box-shadow: 0 12px 40px var(--card-hover);
}

.btn-glass {
  backdrop-filter: blur(10px);
  background: rgba(0, 191, 166, 0.25);
  border: 1px solid rgba(0, 191, 166, 0.4);
  color: #006a58;
  transition: 0.3s;
}
body.dark-mode .btn-glass {
  background: rgba(79, 209, 197, 0.25);
  color: #4fd1c5;
  border-color: rgba(79, 209, 197, 0.4);
}

.btn-glass:hover {
  background: rgba(0, 191, 166, 0.4);
}

.table-hover tbody tr:hover {
  background: rgba(0, 191, 166, 0.05);
}

.theme-toggle {
  cursor: pointer;
  background: transparent;
  border: none;
  font-size: 1.4rem;
  color: var(--text-color);
  transition: transform 0.3s ease;
}

.theme-toggle:hover {
  transform: rotate(20deg);
}
</style>

<div class="container-fluid py-3">

  <!-- HEADER + FILTERS -->
  <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap">
    <h2 class="fw-bold mb-0">
      <i class="fa fa-chart-area text-primary me-2"></i> Dashboard
    </h2>

    <div class="d-flex align-items-center gap-3">
      <button id="themeToggle" class="theme-toggle" title="Prepn√∫≈• t√©mu">
        <i class="fa fa-sun"></i>
      </button>
    </div>
  </div>

  <div class="glass-card p-3 mb-4">
    <form method="get" class="d-flex gap-2 flex-wrap align-items-center">
      {% if user.is_admin %}
      <select name="user_id" class="form-select glass-card">
        <option value="">üë§ V≈°etci pou≈æ√≠vatelia</option>
        {% for u in users %}
          <option value="{{ u.id }}" {% if selected_user == u.id %}selected{% endif %}>{{ u.name }}</option>
        {% endfor %}
      </select>
      {% endif %}

      <select name="project_id" class="form-select glass-card">
        <option value="">üìÅ V≈°etky projekty</option>
        {% for p in projects %}
          <option value="{{ p.id }}" {% if selected_project == p.id %}selected{% endif %}>{{ p.name }}</option>
        {% endfor %}
      </select>

      <select name="unit_type" class="form-select glass-card">
        <option value="">üî¢ V≈°etky jednotky</option>
        <option value="hodiny" {% if unit_type_filter == "hodiny" %}selected{% endif %}>Hodiny</option>
        <option value="m2" {% if unit_type_filter == "m2" %}selected{% endif %}>m¬≤</option>
      </select>

      <button type="submit" class="btn btn-glass">
        <i class="fa fa-filter me-1"></i> Filtrova≈•
      </button>
      <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary">
        <i class="fa fa-rotate-left me-1"></i> Reset
      </a>

      <a href="{{ url_for('export_pdf', user_id=selected_user, project_id=selected_project) }}" class="btn btn-outline-danger ms-auto">
        <i class="fa fa-file-pdf me-1"></i> Exportova≈• PDF
      </a>

      <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addRecordModal">
        <i class="fa fa-plus me-1"></i> Prida≈• z√°znam
      </button>
    </form>
  </div>

  <!-- STATS -->
  <div class="row g-4 mb-4">
    <div class="col-md-3 col-6">
      <div class="glass-card p-3 text-center">
        <h6 class="text-muted mb-1">Celkov√Ω v√Ωkon</h6>
        <h2 class="fw-bold text-primary">{{ "%.2f"|format(total) }}</h2>
        <small>hod√≠n / m¬≤</small>
      </div>
    </div>
    <div class="col-md-3 col-6">
      <div class="glass-card p-3 text-center">
        <h6 class="text-muted mb-1">Poƒçet projektov</h6>
        <h2 class="fw-bold text-primary">{{ project_count }}</h2>
      </div>
    </div>
  </div>

  <!-- CHARTS -->
  <div class="row g-4 mb-4">
    <div class="col-lg-6">
      <div class="glass-card p-4">
        <h6 class="fw-semibold mb-3"><i class="fa fa-clock text-info me-2"></i> Hodiny podƒæa projektu</h6>
        <div style="height: 280px;"><canvas id="hoursChart" data-labels='{{ hours_labels|tojson }}' data-values='{{ hours_values|tojson }}'></canvas></div>
      </div>
    </div>
    <div class="col-lg-6">
      <div class="glass-card p-4">
        <h6 class="fw-semibold mb-3"><i class="fa fa-ruler-combined text-warning me-2"></i> m¬≤ podƒæa projektu</h6>
        <div style="height: 280px;"><canvas id="m2Chart" data-labels='{{ m2_labels|tojson }}' data-values='{{ m2_values|tojson }}'></canvas></div>
      </div>
    </div>
  </div>

  <!-- RECORDS TABLE -->
  <div class="glass-card p-4 shadow-sm mb-5">
    <h5 class="fw-semibold mb-3">üìã Z√°znamy</h5>
    {% if records %}
    <div class="table-responsive">
      <table class="table table-hover align-middle">
        <thead class="table-light">
          <tr>
            <th>D√°tum</th>
            <th>Projekt</th>
            {% if user.is_admin %}<th>Pou≈æ√≠vateƒæ</th>{% endif %}
            <th>Mno≈æstvo</th>
            <th>Jednotka</th>
            <th>Pozn√°mka</th>
            {% if user.is_admin %}<th>Akcia</th>{% endif %}
          </tr>
        </thead>
        <tbody>
          {% for r in records %}
          <tr>
            <td>{{ r.date }}</td>
            <td>{{ r.project.name if r.project else '‚Äî' }}</td>
            {% if user.is_admin %}<td>{{ r.user.name if r.user else '‚Äî' }}</td>{% endif %}
            <td>{{ "%.2f"|format(r.amount) }}</td>
            <td>{{ r.unit_type or '' }}</td>
            <td>{{ r.note or '' }}</td>
            {% if user.is_admin %}
            <td>
              <form method="POST" action="{{ url_for('delete_record', id=r.id) }}" onsubmit="return confirm('Naozaj chce≈° zmaza≈• tento z√°znam?')">
                <button class="btn btn-sm btn-outline-danger"><i class="fa fa-trash"></i></button>
              </form>
            </td>
            {% endif %}
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <div class="alert alert-info mb-0">≈Ωiadne z√°znamy na zobrazenie.</div>
    {% endif %}
  </div>
</div>

<!-- MODAL ADD RECORD -->
<div class="modal fade" id="addRecordModal" tabindex="-1" aria-labelledby="addRecordModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content glass-card">
      <form method="POST" action="{{ url_for('add_record') }}">
        <div class="modal-header border-0">
          <h5 class="modal-title">Prida≈• z√°znam</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Projekt</label>
            <select name="project_id" class="form-select" required>
              {% for p in projects %}
              <option value="{{ p.id }}">{{ p.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">D√°tum</label>
            <input type="date" name="date" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Typ jednotky</label>
            <select name="unit_type" class="form-select" required>
              <option value="hodiny">Hodiny</option>
              <option value="m2">m¬≤</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Mno≈æstvo</label>
            <input type="number" name="amount" step="0.1" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Pozn√°mka</label>
            <input type="text" name="note" class="form-control">
          </div>
        </div>
        <div class="modal-footer border-0">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Zru≈°i≈•</button>
          <button type="submit" class="btn btn-primary">Ulo≈æi≈•</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- JS: Theme toggle + Charts -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  const themeToggle = document.getElementById("themeToggle");
  const icon = themeToggle.querySelector("i");

  if (localStorage.getItem("theme") === "dark") {
    document.body.classList.add("dark-mode");
    icon.classList.replace("fa-sun", "fa-moon");
  }

  themeToggle.addEventListener("click", () => {
    document.body.classList.toggle("dark-mode");
    const dark = document.body.classList.contains("dark-mode");
    icon.classList.replace(dark ? "fa-sun" : "fa-moon", dark ? "fa-moon" : "fa-sun");
    localStorage.setItem("theme", dark ? "dark" : "light");
  });

  const makeChart = (id, type, color) => {
    const el = document.getElementById(id);
    if (!el) return;
    const ctx = el.getContext("2d");
    const labels = JSON.parse(el.dataset.labels || "[]");
    const data = JSON.parse(el.dataset.values || "[]");
    new Chart(ctx, {
      type,
      data: { labels, datasets: [{ data, backgroundColor: color, borderWidth: 2 }] },
      options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
    });
  };

  makeChart("hoursChart", "bar", "#00bfa6");
  makeChart("m2Chart", "bar", "#ffca28");
});
</script>

{% endblock %}
