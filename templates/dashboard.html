{% extends 'base.html' %}
{% block content %}

<style>
:root {
  --bg-gradient: linear-gradient(135deg, #e3f2fd 0%, #f9fbff 100%);
  --glass-bg: rgba(255, 255, 255, 0.55);
  --glass-border: rgba(255, 255, 255, 0.25);
  --text-color: #1e293b;
  --accent: #00bfa6;
  --shadow: rgba(0, 0, 0, 0.1);
}

body.dark-mode {
  --bg-gradient: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
  --glass-bg: rgba(30, 41, 59, 0.5);
  --glass-border: rgba(255, 255, 255, 0.1);
  --text-color: #f1f5f9;
  --accent: #4fd1c5;
  --shadow: rgba(0, 0, 0, 0.4);
}

body {
  background: var(--bg-gradient);
  color: var(--text-color);
  font-family: 'Inter', sans-serif;
  transition: background 0.5s ease, color 0.3s ease;
}

.glass-card {
  backdrop-filter: blur(16px);
  background: var(--glass-bg);
  border: 1px solid var(--glass-border);
  border-radius: 20px;
  box-shadow: 0 8px 32px var(--shadow);
  transition: all 0.3s ease;
}
.glass-card:hover { transform: translateY(-2px); }

/* üåó Prep√≠naƒç t√©my */
.theme-switch {
  position: relative;
  width: 60px;
  height: 32px;
  border-radius: 50px;
  background: var(--glass-bg);
  border: 1px solid var(--glass-border);
  cursor: pointer;
  transition: all 0.4s ease;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 6px;
  box-shadow: inset 0 0 10px rgba(0,0,0,0.05);
}

.theme-switch i {
  font-size: 1.2rem;
  transition: all 0.3s ease;
  color: var(--text-color);
}

.theme-ball {
  position: absolute;
  top: 3px;
  left: 3px;
  width: 26px;
  height: 26px;
  background: var(--accent);
  border-radius: 50%;
  transition: all 0.4s ease;
  box-shadow: 0 0 10px var(--accent);
}

body.dark-mode .theme-ball {
  left: 31px;
  background: var(--accent);
  box-shadow: 0 0 12px var(--accent);
}

/* üßä Sklenen√© tlaƒçidl√° */
.btn-glass {
  backdrop-filter: blur(10px);
  background: rgba(0, 191, 166, 0.25);
  border: 1px solid rgba(0, 191, 166, 0.4);
  color: #006a58;
}
body.dark-mode .btn-glass {
  background: rgba(79, 209, 197, 0.25);
  border-color: rgba(79, 209, 197, 0.4);
  color: #4fd1c5;
}
.btn-glass:hover { background: rgba(0, 191, 166, 0.4); }

/* üéØ R√°dio guliƒçky */
.form-check-input[type="radio"] {
  width: 1.2em;
  height: 1.2em;
  cursor: pointer;
  border: 2px solid var(--accent);
  background-color: transparent;
  transition: all 0.2s ease-in-out;
}
.form-check-input[type="radio"]:hover { box-shadow: 0 0 5px var(--accent); }
.form-check-input[type="radio"]:checked {
  background-color: var(--accent);
  border-color: var(--accent);
  box-shadow: 0 0 6px var(--accent);
}
.form-check-label {
  cursor: pointer;
  font-weight: 500;
  color: var(--text-color);
  margin-left: 0.3em;
  user-select: none;
}
.d-flex.align-items-center.gap-4 .form-check {
  display: flex;
  align-items: center;
  gap: 0.3em;
}
</style>

<div class="container-fluid py-3">

  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap">
    <h2 class="fw-bold mb-0"><i class="fa fa-chart-line text-primary me-2"></i> Dashboard</h2>

    <!-- üåô Elegantn√Ω prep√≠naƒç t√©my -->
    <div id="themeToggle" class="theme-switch" title="Prepn√∫≈• t√©mu">
      <i class="fa fa-sun"></i>
      <i class="fa fa-moon"></i>
      <div class="theme-ball"></div>
    </div>
  </div>

  <!-- Filter -->
  <div class="glass-card p-3 mb-4">
    <form method="get" class="d-flex gap-2 flex-wrap align-items-center">
      {% if user.is_admin %}
      <select name="user_id" class="form-select">
        <option value="">üë§ V≈°etci pou≈æ√≠vatelia</option>
        {% for u in users %}
        <option value="{{ u.id }}" {% if selected_user == u.id %}selected{% endif %}>{{ u.name }}</option>
        {% endfor %}
      </select>
      {% endif %}

      <select name="project_id" class="form-select">
        <option value="">üìÅ V≈°etky projekty</option>
        {% for p in projects %}
        <option value="{{ p.id }}" {% if selected_project == p.id %}selected{% endif %}>{{ p.name }}</option>
        {% endfor %}
      </select>

      <select name="unit_type" class="form-select">
        <option value="">üî¢ V≈°etky jednotky</option>
        <option value="hodiny" {% if unit_type_filter == "hodiny" %}selected{% endif %}>Hodiny</option>
        <option value="m2" {% if unit_type_filter == "m2" %}selected{% endif %}>m¬≤</option>
      </select>

      <!-- üÜï FILTER PODƒΩA ROKU -->
      <select name="year" class="form-select">
        <option value="">üìÖ V≈°etky roky</option>
        {% for y in range(2023, 2031) %}
        <option value="{{ y }}" {% if selected_year == y %}selected{% endif %}>{{ y }}</option>
        {% endfor %}
      </select>

      <!-- üÜï FILTER PODƒΩA T√ù≈ΩD≈áA -->
      <select name="week" class="form-select">
        <option value="">üóìÔ∏è V≈°etky t√Ω≈ædne</option>
        {% for w in range(1, 54) %}
        <option value="{{ w }}" {% if selected_week == w %}selected{% endif %}>T√Ω≈æde≈à {{ w }}</option>
        {% endfor %}
      </select>

      <button type="submit" class="btn btn-glass">
        <i class="fa fa-filter me-1"></i> Filtrova≈•
      </button>

      <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary">
        <i class="fa fa-rotate-left me-1"></i> Reset
      </a>

    <a href="{{ url_for('export_pdf',
        user_id=selected_user,
        project_id=selected_project,
        unit_type=unit_type_filter,
        year=selected_year,
        week=selected_week
    ) }}" class="btn btn-outline-danger ms-auto">
        <i class="fa fa-file-pdf me-1"></i> Exportova≈• PDF
      </a>

      <!-- ‚úÖ Prida≈• z√°znam -->
      <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addRecordModal">
        <i class="fa fa-plus me-1"></i> Prida≈• z√°znam
      </button>
    </form>
  </div>

  <!-- Charts -->
  <div class="row g-4 mb-4">
    <div class="col-lg-6">
      <div class="glass-card p-4">
        <h6><i class="fa fa-clock text-info me-2"></i> V√Ωkon podƒæa hod√≠n</h6>
        <div style="height:280px;">
          <canvas id="hoursDateChart"
            data-labels='{{ chart_labels_hours|tojson }}'
            data-values='{{ chart_values_hours|tojson }}'></canvas>
        </div>
      </div>
    </div>
    <div class="col-lg-6">
      <div class="glass-card p-4">
        <h6><i class="fa fa-ruler-combined text-warning me-2"></i> V√Ωkon podƒæa m¬≤</h6>
        <div style="height:280px;">
          <canvas id="m2DateChart"
            data-labels='{{ chart_labels_m2|tojson }}'
            data-values='{{ chart_values_m2|tojson }}'></canvas>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-4 mb-4">
    <div class="col-lg-6">
      <div class="glass-card p-4">
        <h6><i class="fa fa-clock text-info me-2"></i> Hodiny podƒæa projektu</h6>
        <div style="height:280px;">
          <canvas id="hoursChart"
            data-labels='{{ hours_labels|tojson }}'
            data-values='{{ hours_values|tojson }}'></canvas>
        </div>
      </div>
    </div>
    <div class="col-lg-6">
      <div class="glass-card p-4">
        <h6><i class="fa fa-ruler-combined text-warning me-2"></i> m¬≤ podƒæa projektu</h6>
        <div style="height:280px;">
          <canvas id="m2Chart"
            data-labels='{{ m2_labels|tojson }}'
            data-values='{{ m2_values|tojson }}'></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Records Table -->
  <div class="glass-card p-4 mb-5">
    <h5 class="fw-semibold mb-3">üìã Z√°znamy</h5>

    <!-- üÜï Info o t√Ω≈ædni -->
    <p class="text-muted mb-3">
      üìÖ Zobrazuje sa t√Ω≈æde≈à <strong>{{ selected_week }}</strong> / <strong>{{ selected_year }}</strong>
    </p>

    {% if records %}
    <div class="table-responsive">
      <table class="table table-hover align-middle">
        <thead class="table-light">
          <tr>
            <th>D√°tum</th>
            <th>Projekt</th>
            {% if user.is_admin %}<th>Pou≈æ√≠vateƒæ</th>{% endif %}
            <th>Mno≈æstvo</th>
            <th>Jednotka</th>
            <th>Pozn√°mka</th>
            <th>Akcie</th>
          </tr>
        </thead>
        <tbody>
          {% for r in records %}
          <tr>
            <td>{{ r.date }}</td>
            <td>{{ r.project.name if r.project else '‚Äî' }}</td>
            {% if user.is_admin %}<td>{{ r.user.name if r.user else '‚Äî' }}</td>{% endif %}
            <td>{{ "%.2f"|format(r.amount) }}</td>
            <td>{{ r.unit_type or '' }}</td>
            <td>{{ r.note or '' }}</td>
            <td>
              {% if user.is_admin or r.user_id == user.id %}
              <div class="d-flex gap-2">
                <a href="{{ url_for('edit_record', id=r.id) }}" class="btn btn-sm btn-outline-primary" title="Upravi≈•">
                  <i class="fa fa-pen"></i>
                </a>
                <form method="POST" action="{{ url_for('delete_record', id=r.id) }}" 
                      onsubmit="return confirm('Naozaj chce≈° zmaza≈• tento z√°znam?');">
                  <button class="btn btn-sm btn-outline-danger" title="Vymaza≈•"><i class="fa fa-trash"></i></button>
                </form>
              </div>
              {% else %}
              <span class="text-muted small">‚Äì</span>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <div class="alert alert-info mb-0">≈Ωiadne z√°znamy na zobrazenie.</div>
    {% endif %}
  </div>
</div>

<!-- Modal Add Record -->
<div class="modal fade" id="addRecordModal" tabindex="-1" aria-labelledby="addRecordModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content glass-card">
      <form method="POST" action="{{ url_for('add_record') }}">
        <div class="modal-header border-0">
          <h5 class="modal-title">Prida≈• z√°znam</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Projekt</label>
            <select name="project_id" class="form-select" required>
              {% for p in projects %}
              <option value="{{ p.id }}">{{ p.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">D√°tum</label>
            <input type="date" name="date" class="form-control" required>
          </div>
          <div class="col-md-3">
            <div class="mb-3">
              <label class="form-label d-block mb-2">Typ jednotky</label>
              <div class="d-flex align-items-center gap-4">
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="unit_type" id="unit_hodiny" value="hodiny" checked>
                  <label class="form-check-label" for="unit_hodiny">Hodiny</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="unit_type" id="unit_m2" value="m2">
                  <label class="form-check-label" for="unit_m2">m¬≤</label>
                </div>
              </div>
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label">Mno≈æstvo</label>
            <input type="number" name="amount" step="0.1" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Pozn√°mka</label>
            <input type="text" name="note" class="form-control">
          </div>
        </div>
        <div class="modal-footer border-0">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Zru≈°i≈•</button>
          <button type="submit" class="btn btn-primary">Ulo≈æi≈•</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- JS -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  const toggle = document.getElementById("themeToggle");
  const body = document.body;
  const saved = localStorage.getItem("theme");
  if (saved === "dark") body.classList.add("dark-mode");

  toggle.addEventListener("click", () => {
    body.classList.toggle("dark-mode");
    localStorage.setItem("theme", body.classList.contains("dark-mode") ? "dark" : "light");
  });

  const makeChart = (id, type, color, gradient = false) => {
  const el = document.getElementById(id);
  if (!el) return;
  const ctx = el.getContext("2d");
  
  const labels = JSON.parse(el.dataset.labels || "[]");
  const data = JSON.parse(el.dataset.values || "[]");

  // üß≠ Debug ‚Äì uk√°≈æe v konzole d√°ta pre ka≈æd√Ω graf
  console.log(`Graf: ${id}`, labels, data);

  if (!labels.length || !data.length) {
    console.warn(`‚ö†Ô∏è Graf ${id} nem√° d√°ta, preskakujem`);
    return;
  }

  let bgColor = color;
  if (gradient) {
    const grad = ctx.createLinearGradient(0, 0, 0, 200);
    grad.addColorStop(0, color + "cc");
    grad.addColorStop(1, color + "11");
    bgColor = grad;
  }

  new Chart(ctx, {
    type,
    data: {
      labels,
      datasets: [{
        label: id,
        data,
        fill: gradient,
        borderColor: color,
        backgroundColor: bgColor,
        borderWidth: 2,
        tension: 0.4,
        pointRadius: 4
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        y: {
          beginAtZero: true,   // ‚úÖ v≈ædy od nuly
          ticks: { precision: 0 } // üîπ zaokr√∫hlen√© hodnoty
        }
      }
    }
  });
};

  makeChart("dateChart", "line", "#00bfa6", true);
  makeChart("hoursChart", "bar", "#00bfa6");
  makeChart("m2Chart", "bar", "#ffca28");
  makeChart("hoursDateChart", "line", "#00bfa6", true);
  makeChart("m2DateChart", "line", "#ffca28", true);
});
</script>

{% endblock %}
