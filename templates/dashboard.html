{% extends 'base.html' %}
{% block content %}

<style>
/* 🌈 GLASSMORPHISM STYLE */
body {
  background: linear-gradient(135deg, #dff6ff 0%, #ffffff 100%);
  font-family: 'Inter', sans-serif;
}

.glass-card {
  backdrop-filter: blur(14px);
  background: rgba(255, 255, 255, 0.45);
  border: 1px solid rgba(255, 255, 255, 0.25);
  border-radius: 20px;
  box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
  transition: all 0.3s ease;
}

.glass-card:hover {
  transform: translateY(-3px);
  box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
}

.stat-card {
  text-align: center;
  padding: 20px;
}

.stat-card h2 {
  font-size: 2rem;
}

.btn-glass {
  backdrop-filter: blur(10px);
  background: rgba(0, 191, 166, 0.2);
  border: 1px solid rgba(0, 191, 166, 0.4);
  color: #006a58;
  transition: 0.3s;
}

.btn-glass:hover {
  background: rgba(0, 191, 166, 0.35);
}

.chart-wrapper {
  height: 300px;
}
</style>

<div class="container-fluid py-3">

  <!-- HEADER -->
  <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap">
    <h2 class="fw-bold text-dark mb-0">
      <i class="fa fa-chart-area text-primary me-2"></i> Dashboard
    </h2>

    <form method="get" class="d-flex gap-2 flex-wrap align-items-center">
      {% if user.is_admin %}
      <select name="user_id" class="form-select glass-card">
        <option value="">👤 Všetci používatelia</option>
        {% for u in users %}
          <option value="{{ u.id }}" {% if selected_user == u.id %}selected{% endif %}>{{ u.name }}</option>
        {% endfor %}
      </select>
      {% endif %}
      <select name="project_id" class="form-select glass-card">
        <option value="">📁 Všetky projekty</option>
        {% for p in projects %}
          <option value="{{ p.id }}" {% if selected_project == p.id %}selected{% endif %}>{{ p.name }}</option>
        {% endfor %}
      </select>
      <select name="unit_type" class="form-select glass-card">
        <option value="">🔢 Všetky jednotky</option>
        <option value="hodiny" {% if unit_type_filter == "hodiny" %}selected{% endif %}>Hodiny</option>
        <option value="m2" {% if unit_type_filter == "m2" %}selected{% endif %}>m²</option>
      </select>

      <button type="submit" class="btn btn-glass">
        <i class="fa fa-filter me-1"></i> Filtrovať
      </button>
      <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary">
        <i class="fa fa-rotate-left me-1"></i> Reset
      </a>
    </form>
  </div>

  <!-- STATS -->
  <div class="row g-4 mb-4">
    <div class="col-md-3 col-6">
      <div class="glass-card p-3 text-center">
        <h6 class="text-muted mb-1">Celkový výkon</h6>
        <h2 class="fw-bold text-primary">{{ "%.2f"|format(total) }}</h2>
        <small>hodín / m²</small>
      </div>
    </div>
    <div class="col-md-3 col-6">
      <div class="glass-card p-3 text-center">
        <h6 class="text-muted mb-1">Počet projektov</h6>
        <h2 class="fw-bold text-primary">{{ project_count }}</h2>
      </div>
    </div>
  </div>

  <!-- GRAPHS -->
  <div class="row g-4 mb-4">
    <div class="col-lg-6">
      <div class="glass-card p-4">
        <h6 class="fw-semibold mb-3"><i class="fa fa-clock text-info me-2"></i> Hodiny podľa projektu</h6>
        <div class="chart-wrapper">
          <canvas id="hoursChart"
            data-labels='{{ hours_labels|tojson }}'
            data-values='{{ hours_values|tojson }}'></canvas>
        </div>
      </div>
    </div>

    <div class="col-lg-6">
      <div class="glass-card p-4">
        <h6 class="fw-semibold mb-3"><i class="fa fa-ruler-combined text-warning me-2"></i> m² podľa projektu</h6>
        <div class="chart-wrapper">
          <canvas id="m2Chart"
            data-labels='{{ m2_labels|tojson }}'
            data-values='{{ m2_values|tojson }}'></canvas>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-4 mb-4">
    <div class="col-lg-6">
      <div class="glass-card p-4">
        <h6 class="fw-semibold mb-3"><i class="fa fa-calendar text-success me-2"></i> Výkon podľa dátumu</h6>
        <div class="chart-wrapper">
          <canvas id="dateChart"
            data-labels='{{ chart_labels|tojson }}'
            data-values='{{ chart_values|tojson }}'></canvas>
        </div>
      </div>
    </div>

    <div class="col-lg-6">
      <div class="glass-card p-4">
        <h6 class="fw-semibold mb-3"><i class="fa fa-chart-pie text-danger me-2"></i> Rozdelenie jednotiek</h6>
        <div class="chart-wrapper">
          <canvas id="unitChart"
            data-labels='{{ unit_labels|tojson }}'
            data-values='{{ unit_values|tojson }}'></canvas>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- JS -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  const makeGradient = (ctx, color1, color2) => {
    const gradient = ctx.createLinearGradient(0, 0, 0, 400);
    gradient.addColorStop(0, color1);
    gradient.addColorStop(1, color2);
    return gradient;
  };

  const makeChart = (id, type, color1, color2) => {
    const el = document.getElementById(id);
    if (!el) return;
    const ctx = el.getContext('2d');
    const labels = JSON.parse(el.dataset.labels);
    const data = JSON.parse(el.dataset.values);
    new Chart(ctx, {
      type: type,
      data: {
        labels: labels,
        datasets: [{
          data: data,
          label: '',
          backgroundColor: type === 'bar' || type === 'line' ? makeGradient(ctx, color1, color2) : [color1, color2, '#ffb74d', '#90caf9'],
          borderColor: color1,
          fill: true,
          tension: 0.3,
          borderWidth: 2
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            backgroundColor: 'rgba(255,255,255,0.8)',
            titleColor: '#000',
            bodyColor: '#000',
            borderColor: '#ccc',
            borderWidth: 1
          }
        },
        scales: type !== 'doughnut' ? {
          y: { beginAtZero: true, grid: { color: 'rgba(200,200,200,0.2)' } },
          x: { grid: { display: false } }
        } : {}
      }
    });
  };

  makeChart("hoursChart", "bar", "#00bfa6", "#b2fef7");
  makeChart("m2Chart", "bar", "#ffca28", "#ffe082");
  makeChart("dateChart", "line", "#64b5f6", "#e3f2fd");
  makeChart("unitChart", "doughnut", "#00bfa6", "#ffca28");
});
</script>

{% endblock %}
