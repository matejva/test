{% extends 'base.html' %}
{% block content %}

<style>
/* 💠 Elegantné rádio guličky */
.fancy-radio {
  display: flex;
  align-items: center;
  gap: 0.5em;
  padding: 0.4em 0.8em;
  border-radius: 10px;
  background: rgba(0, 191, 166, 0.08);
  transition: all 0.3s ease;
  cursor: pointer;
}

.fancy-radio:hover {
  background: rgba(0, 191, 166, 0.15);
  transform: translateY(-1px);
}

/* Gulička */
.fancy-radio .form-check-input {
  appearance: none;
  width: 1.2em;
  height: 1.2em;
  border-radius: 50%;
  border: 2px solid var(--accent);
  background-color: transparent;
  cursor: pointer;
  position: relative;
  transition: all 0.25s ease;
}

/* Zapnutá gulička */
.fancy-radio .form-check-input:checked {
  background: var(--accent);
  box-shadow: 0 0 10px var(--accent);
  animation: pulse 0.3s ease;
}

/* Text vedľa */
.fancy-radio .form-check-label {
  margin-left: 0.4em;
  font-weight: 500;
  color: var(--text-color);
  transition: color 0.3s ease;
}

.fancy-radio .form-check-input:checked + .form-check-label {
  color: var(--accent);
}

/* Animácia kliknutia */
@keyframes pulse {
  0% { transform: scale(0.8); opacity: 0.8; }
  50% { transform: scale(1.2); opacity: 1; }
  100% { transform: scale(1); opacity: 1; }
}
</style>

<div class="container-fluid py-3">

  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap">
    <h2 class="fw-bold mb-0"><i class="fa fa-chart-line text-primary me-2"></i> Dashboard</h2>

    <!-- 🌙 Elegantný prepínač témy -->
    <div id="themeToggle" class="theme-switch" title="Prepnúť tému">
      <i class="fa fa-sun"></i>
      <i class="fa fa-moon"></i>
      <div class="theme-ball"></div>
    </div>
  </div>

  <!-- Filter -->
  <div class="glass-card p-3 mb-4">
    <form method="get" class="d-flex gap-2 flex-wrap align-items-center">
      {% if user.is_admin %}
      <select name="user_id" class="form-select">
        <option value="">👤 Všetci používatelia</option>
        {% for u in users %}
        <option value="{{ u.id }}" {% if selected_user == u.id %}selected{% endif %}>{{ u.name }}</option>
        {% endfor %}
      </select>
      {% endif %}

      <select name="project_id" class="form-select">
        <option value="">📁 Všetky projekty</option>
        {% for p in projects %}
        <option value="{{ p.id }}" {% if selected_project == p.id %}selected{% endif %}>{{ p.name }}</option>
        {% endfor %}
      </select>

      <select name="unit_type" class="form-select">
        <option value="">🔢 Všetky jednotky</option>
        <option value="hodiny" {% if unit_type_filter == "hodiny" %}selected{% endif %}>Hodiny</option>
        <option value="m2" {% if unit_type_filter == "m2" %}selected{% endif %}>m²</option>
      </select>

      <button type="submit" class="btn btn-glass">
        <i class="fa fa-filter me-1"></i> Filtrovať
      </button>

      <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary">
        <i class="fa fa-rotate-left me-1"></i> Reset
      </a>

      <a href="{{ url_for('export_pdf', user_id=selected_user, project_id=selected_project) }}" 
         class="btn btn-outline-danger ms-auto">
        <i class="fa fa-file-pdf me-1"></i> Exportovať PDF
      </a>

      <!-- ✅ Pridať záznam -->
      <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addRecordModal">
        <i class="fa fa-plus me-1"></i> Pridať záznam
      </button>
    </form>
  </div>

  <!-- Charts -->
  <div class="row g-4 mb-4">
    <div class="col-lg-12">
      <div class="glass-card p-4">
        <h6 class="fw-semibold mb-3">
          <i class="fa fa-calendar text-success me-2"></i> Výkon podľa dátumu
        </h6>
        <div style="height: 280px;">
          <canvas id="dateChart" 
            data-labels='{{ chart_labels|tojson }}'
            data-values='{{ chart_values|tojson }}'></canvas>
        </div>
      </div>
    </div>

    <div class="col-lg-6">
      <div class="glass-card p-4">
        <h6 class="fw-semibold mb-3"><i class="fa fa-clock text-info me-2"></i> Hodiny podľa projektu</h6>
        <div style="height: 280px;">
          <canvas id="hoursChart" 
            data-labels='{{ hours_labels|tojson }}'
            data-values='{{ hours_values|tojson }}'></canvas>
        </div>
      </div>
    </div>
    <div class="col-lg-6">
      <div class="glass-card p-4">
        <h6 class="fw-semibold mb-3"><i class="fa fa-ruler-combined text-warning me-2"></i> m² podľa projektu</h6>
        <div style="height: 280px;">
          <canvas id="m2Chart" 
            data-labels='{{ m2_labels|tojson }}'
            data-values='{{ m2_values|tojson }}'></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Records Table -->
  <div class="glass-card p-4 mb-5">
    <h5 class="fw-semibold mb-3">📋 Záznamy</h5>
    {% if records %}
    <div class="table-responsive">
      <table class="table table-hover align-middle">
        <thead class="table-light">
          <tr>
            <th>Dátum</th>
            <th>Projekt</th>
            {% if user.is_admin %}<th>Používateľ</th>{% endif %}
            <th>Množstvo</th>
            <th>Jednotka</th>
            <th>Poznámka</th>
            {% if user.is_admin %}<th>Akcia</th>{% endif %}
          </tr>
        </thead>
        <tbody>
          {% for r in records %}
          <tr>
            <td>{{ r.date }}</td>
            <td>{{ r.project.name if r.project else '—' }}</td>
            {% if user.is_admin %}<td>{{ r.user.name if r.user else '—' }}</td>{% endif %}
            <td>{{ "%.2f"|format(r.amount) }}</td>
            <td>{{ r.unit_type or '' }}</td>
            <td>{{ r.note or '' }}</td>
            {% if user.is_admin %}
            <td>
              <form method="POST" action="{{ url_for('delete_record', id=r.id) }}" 
                    onsubmit="return confirm('Naozaj chceš zmazať tento záznam?')">
                <button class="btn btn-sm btn-outline-danger"><i class="fa fa-trash"></i></button>
              </form>
            </td>
            {% endif %}
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <div class="alert alert-info mb-0">Žiadne záznamy na zobrazenie.</div>
    {% endif %}
  </div>
</div>

<!-- Modal Add Record -->
<div class="modal fade" id="addRecordModal" tabindex="-1" aria-labelledby="addRecordModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content glass-card">
      <form method="POST" action="{{ url_for('add_record') }}">
        <div class="modal-header border-0">
          <h5 class="modal-title">Pridať záznam</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Projekt</label>
            <select name="project_id" class="form-select" required>
              {% for p in projects %}
              <option value="{{ p.id }}">{{ p.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Dátum</label>
            <input type="date" name="date" class="form-control" required>
          </div>
         <div class="col-md-3">
<!-- 🟢 Typ jednotky -->
<div class="mb-3">
  <label class="form-label d-block mb-2">Typ jednotky</label>
  <div class="d-flex gap-3 align-items-center flex-wrap">
    <div class="form-check form-check-inline fancy-radio">
      <input class="form-check-input" type="radio" name="unit_type" id="unit_hodiny" value="hodiny" checked>
      <label class="form-check-label" for="unit_hodiny">🕒 Hodiny</label>
    </div>
    <div class="form-check form-check-inline fancy-radio">
      <input class="form-check-input" type="radio" name="unit_type" id="unit_m2" value="m2">
      <label class="form-check-label" for="unit_m2">📐 m²</label>
    </div>
  </div>
</div>
          </div>
          <div class="mb-3">
            <label class="form-label">Množstvo</label>
            <input type="number" name="amount" step="0.1" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Poznámka</label>
            <input type="text" name="note" class="form-control">
          </div>
        </div>
        <div class="modal-footer border-0">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Zrušiť</button>
          <button type="submit" class="btn btn-primary">Uložiť</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- JS -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  // 🌗 Theme toggle with smooth animation
  const toggle = document.getElementById("themeToggle");
  const body = document.body;
  const saved = localStorage.getItem("theme");
  if (saved === "dark") body.classList.add("dark-mode");

  toggle.addEventListener("click", () => {
    body.classList.toggle("dark-mode");
    localStorage.setItem("theme", body.classList.contains("dark-mode") ? "dark" : "light");
  });

  // 📈 Charts
  const makeChart = (id, type, color, gradient = false) => {
    const el = document.getElementById(id);
    if (!el) return;
    const ctx = el.getContext("2d");
    const labels = JSON.parse(el.dataset.labels || "[]");
    const data = JSON.parse(el.dataset.values || "[]");

    let bgColor = color;
    if (gradient) {
      const grad = ctx.createLinearGradient(0, 0, 0, 200);
      grad.addColorStop(0, color + "cc");
      grad.addColorStop(1, color + "11");
      bgColor = grad;
    }

    new Chart(ctx, {
      type,
      data: {
        labels,
        datasets: [{ 
          data, 
          fill: gradient, 
          borderColor: color, 
          backgroundColor: bgColor, 
          tension: 0.4, 
          pointRadius: 4,
          borderWidth: 2 
        }]
      },
      options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
    });
  };

  makeChart("dateChart", "line", "#00bfa6", true);
  makeChart("hoursChart", "bar", "#00bfa6");
  makeChart("m2Chart", "bar", "#ffca28");
});
</script>

{% endblock %}
