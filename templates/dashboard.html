{% extends 'base.html' %}
{% block content %}

<style>
/* üåà GLASSMORPHISM DASHBOARD */
body {
  background: linear-gradient(135deg, #e3f2fd 0%, #f9fbff 100%);
  font-family: 'Inter', sans-serif;
}

.glass-card {
  backdrop-filter: blur(16px);
  background: rgba(255, 255, 255, 0.45);
  border-radius: 20px;
  border: 1px solid rgba(255, 255, 255, 0.25);
  box-shadow: 0 8px 32px rgba(31, 38, 135, 0.1);
  transition: all 0.3s ease;
}

.glass-card:hover {
  transform: translateY(-3px);
  box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
}

.btn-glass {
  backdrop-filter: blur(10px);
  background: rgba(0, 191, 166, 0.25);
  border: 1px solid rgba(0, 191, 166, 0.4);
  color: #006a58;
  transition: 0.3s;
}

.btn-glass:hover {
  background: rgba(0, 191, 166, 0.4);
}

.chart-wrapper {
  height: 280px;
}

.table-hover tbody tr:hover {
  background: rgba(0, 191, 166, 0.05);
}
</style>

<div class="container-fluid py-3">

  <!-- HEADER + FILTERS -->
  <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap">
    <h2 class="fw-bold text-dark mb-0"><i class="fa fa-chart-area text-primary me-2"></i> Dashboard</h2>

    <form method="get" class="d-flex gap-2 flex-wrap align-items-center">
      {% if user.is_admin %}
      <select name="user_id" class="form-select glass-card">
        <option value="">üë§ V≈°etci pou≈æ√≠vatelia</option>
        {% for u in users %}
          <option value="{{ u.id }}" {% if selected_user == u.id %}selected{% endif %}>{{ u.name }}</option>
        {% endfor %}
      </select>
      {% endif %}

      <select name="project_id" class="form-select glass-card">
        <option value="">üìÅ V≈°etky projekty</option>
        {% for p in projects %}
          <option value="{{ p.id }}" {% if selected_project == p.id %}selected{% endif %}>{{ p.name }}</option>
        {% endfor %}
      </select>

      <select name="unit_type" class="form-select glass-card">
        <option value="">üî¢ V≈°etky jednotky</option>
        <option value="hodiny" {% if unit_type_filter == "hodiny" %}selected{% endif %}>Hodiny</option>
        <option value="m2" {% if unit_type_filter == "m2" %}selected{% endif %}>m¬≤</option>
      </select>

      <button type="submit" class="btn btn-glass"><i class="fa fa-filter me-1"></i> Filtrova≈•</button>
      <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary"><i class="fa fa-rotate-left me-1"></i> Reset</a>
    </form>

    <div class="d-flex gap-2 mt-2 mt-md-0">
      <a href="{{ url_for('export_pdf', user_id=selected_user, project_id=selected_project) }}" class="btn btn-outline-danger">
        <i class="fa fa-file-pdf me-1"></i> Exportova≈• PDF
      </a>
      <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addRecordModal">
        <i class="fa fa-plus me-1"></i> Prida≈• z√°znam
      </button>
    </div>
  </div>

  <!-- STATS -->
  <div class="row g-4 mb-4">
    <div class="col-md-3 col-6">
      <div class="glass-card p-3 text-center">
        <h6 class="text-muted mb-1">Celkov√Ω v√Ωkon</h6>
        <h2 class="fw-bold text-primary">{{ "%.2f"|format(total) }}</h2>
        <small>hod√≠n / m¬≤</small>
      </div>
    </div>
    <div class="col-md-3 col-6">
      <div class="glass-card p-3 text-center">
        <h6 class="text-muted mb-1">Poƒçet projektov</h6>
        <h2 class="fw-bold text-primary">{{ project_count }}</h2>
      </div>
    </div>
  </div>

  <!-- CHARTS -->
  <div class="row g-4 mb-4">
    <div class="col-lg-6">
      <div class="glass-card p-4">
        <h6 class="fw-semibold mb-3"><i class="fa fa-clock text-info me-2"></i> Hodiny podƒæa projektu</h6>
        <div class="chart-wrapper">
          <canvas id="hoursChart" data-labels='{{ hours_labels|tojson }}' data-values='{{ hours_values|tojson }}'></canvas>
        </div>
      </div>
    </div>
    <div class="col-lg-6">
      <div class="glass-card p-4">
        <h6 class="fw-semibold mb-3"><i class="fa fa-ruler-combined text-warning me-2"></i> m¬≤ podƒæa projektu</h6>
        <div class="chart-wrapper">
          <canvas id="m2Chart" data-labels='{{ m2_labels|tojson }}' data-values='{{ m2_values|tojson }}'></canvas>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-4 mb-4">
    <div class="col-lg-6">
      <div class="glass-card p-4">
        <h6 class="fw-semibold mb-3"><i class="fa fa-calendar text-success me-2"></i> V√Ωkon podƒæa d√°tumu</h6>
        <div class="chart-wrapper">
          <canvas id="dateChart" data-labels='{{ chart_labels|tojson }}' data-values='{{ chart_values|tojson }}'></canvas>
        </div>
      </div>
    </div>
    <div class="col-lg-6">
      <div class="glass-card p-4">
        <h6 class="fw-semibold mb-3"><i class="fa fa-chart-pie text-danger me-2"></i> Rozdelenie jednotiek</h6>
        <div class="chart-wrapper">
          <canvas id="unitChart" data-labels='{{ unit_labels|tojson }}' data-values='{{ unit_values|tojson }}'></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- RECORDS TABLE -->
  <div class="glass-card p-4 shadow-sm mb-5">
    <h5 class="fw-semibold mb-3">üìã Zoznam z√°znamov</h5>
    {% if records %}
    <div class="table-responsive">
      <table class="table table-hover align-middle">
        <thead class="table-light">
          <tr>
            <th>D√°tum</th>
            <th>Projekt</th>
            {% if user.is_admin %}<th>Pou≈æ√≠vateƒæ</th>{% endif %}
            <th>Mno≈æstvo</th>
            <th>Jednotka</th>
            <th>Pozn√°mka</th>
            {% if user.is_admin %}<th>Akcia</th>{% endif %}
          </tr>
        </thead>
        <tbody>
          {% for r in records %}
          <tr>
            <td>{{ r.date }}</td>
            <td>{{ r.project.name if r.project else '‚Äî' }}</td>
            {% if user.is_admin %}<td>{{ r.user.name if r.user else '‚Äî' }}</td>{% endif %}
            <td>{{ "%.2f"|format(r.amount) }}</td>
            <td>{{ r.unit_type or '' }}</td>
            <td>{{ r.note or '' }}</td>
            {% if user.is_admin %}
            <td>
              <form method="POST" action="{{ url_for('delete_record', id=r.id) }}" onsubmit="return confirm('Naozaj chce≈° zmaza≈• tento z√°znam?')">
                <button class="btn btn-sm btn-outline-danger"><i class="fa fa-trash"></i></button>
              </form>
            </td>
            {% endif %}
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <div class="alert alert-info mb-0">≈Ωiadne z√°znamy na zobrazenie.</div>
    {% endif %}
  </div>
</div>

<!-- MODAL ADD RECORD -->
<div class="modal fade" id="addRecordModal" tabindex="-1" aria-labelledby="addRecordModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content glass-card">
      <form method="POST" action="{{ url_for('add_record') }}">
        <div class="modal-header border-0">
          <h5 class="modal-title" id="addRecordModalLabel">Prida≈• z√°znam</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Projekt</label>
            <select name="project_id" class="form-select" required>
              {% for p in projects %}
              <option value="{{ p.id }}">{{ p.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">D√°tum</label>
            <input type="date" name="date" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Typ jednotky</label>
            <select name="unit_type" class="form-select" required>
              <option value="hodiny">Hodiny</option>
              <option value="m2">m¬≤</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Mno≈æstvo</label>
            <input type="number" name="amount" step="0.1" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Pozn√°mka</label>
            <input type="text" name="note" class="form-control">
          </div>
        </div>
        <div class="modal-footer border-0">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Zru≈°i≈•</button>
          <button type="submit" class="btn btn-primary">Ulo≈æi≈•</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- CHARTS JS -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  const makeGradient = (ctx, color1, color2) => {
    const g = ctx.createLinearGradient(0, 0, 0, 300);
    g.addColorStop(0, color1);
    g.addColorStop(1, color2);
    return g;
  };

  const makeChart = (id, type, c1, c2) => {
    const el = document.getElementById(id);
    if (!el) return;
    const ctx = el.getContext('2d');
    const labels = JSON.parse(el.dataset.labels || "[]");
    const data = JSON.parse(el.dataset.values || "[]");
    new Chart(ctx, {
      type,
      data: {
        labels,
        datasets: [{
          data,
          label: '',
          backgroundColor: type === 'doughnut' ? [c1, c2, '#ffd54f', '#81c784'] : makeGradient(ctx, c1, c2),
          borderColor: c1,
          borderWidth: 2,
          fill: true,
          tension: 0.3
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: type === 'doughnut' },
          tooltip: {
            backgroundColor: 'rgba(255,255,255,0.85)',
            titleColor: '#000',
            bodyColor: '#000'
          }
        },
        scales: type !== 'doughnut' ? {
          y: { beginAtZero: true, grid: { color: 'rgba(200,200,200,0.2)' } },
          x: { grid: { display: false } }
        } : {}
      }
    });
  };

  makeChart("hoursChart", "bar", "#00bfa6", "#b2fef7");
  makeChart("m2Chart", "bar", "#ffca28", "#ffe082");
  makeChart("dateChart", "line", "#64b5f6", "#e3f2fd");
  makeChart("unitChart", "doughnut", "#00bfa6", "#ffca28");
});
</script>

{% endblock %}
