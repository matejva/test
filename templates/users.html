{% extends 'base.html' %}
{% block content %}
<div class="container-fluid">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h3 class="fw-bold mb-0">Používatelia</h3>
    {% if user.is_admin %}
    <a href="{{ url_for('create_user') }}" class="btn btn-primary">
      <i class="fa fa-user-plus me-2"></i> Pridať používateľa
    </a>
    {% endif %}
  </div>

  {% if users %}
  <div class="row">
    {% for u in users %}
    <div class="col-md-4 col-lg-3 mb-4">
      <div class="card user-card shadow-sm text-center">
        <div class="card-body">
          <div class="avatar-circle bg-gradient mb-3">
            <span class="initials">{{ u.name[:2]|upper }}</span>
          </div>
          <h5 class="fw-bold mb-1">{{ u.name }}</h5>
          <p class="text-muted mb-2 small">{{ u.email or 'Bez e-mailu' }}</p>

          {% if u.is_admin %}
            <span class="badge bg-success px-3 py-2">Admin</span>
          {% else %}
            <span class="badge bg-secondary px-3 py-2">Používateľ</span>
          {% endif %}

          {% if user.is_admin or user.id == u.id %}
          <!-- Tlačidlo na otvorenie modalu -->
          <button type="button" class="btn btn-warning btn-sm mt-3"
                  data-bs-toggle="modal"
                  data-bs-target="#changePassModal{{ u.id }}">
            <i class="fa fa-key me-1"></i> Zmeniť heslo
          </button>

          <!-- Modal -->
          <div class="modal fade" id="changePassModal{{ u.id }}" tabindex="-1"
               aria-labelledby="changePassLabel{{ u.id }}" aria-hidden="true" data-bs-backdrop="static">
            <div class="modal-dialog modal-dialog-centered">
              <div class="modal-content">
                <form method="POST" action="{{ url_for('change_password', user_id=u.id) }}">
                  <div class="modal-header border-0">
                    <h5 class="modal-title">
                      <i class="fa fa-key me-2 text-warning"></i>
                      {% if user.id == u.id and not user.is_admin %}
                        Zmeniť svoje heslo
                      {% else %}
                        Zmena hesla pre {{ u.name }}
                      {% endif %}
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                  </div>

                  <div class="modal-body">
                    <label class="form-label">Nové heslo</label>
                    <div class="input-group mb-3">
                      <input type="password" name="new_password" class="form-control" required minlength="4"
                             placeholder="Zadaj nové heslo" id="passwordInput{{ u.id }}">
                      <button class="btn btn-outline-secondary" type="button"
                              onclick="togglePassword('passwordInput{{ u.id }}', this)">
                        <i class="fa fa-eye"></i>
                      </button>
                    </div>

                    <label class="form-label">Zopakuj heslo</label>
                    <div class="input-group">
                      <input type="password" name="confirm_password" class="form-control" required minlength="4"
                             placeholder="Zopakuj nové heslo" id="passwordConfirm{{ u.id }}">
                      <button class="btn btn-outline-secondary" type="button"
                              onclick="togglePassword('passwordConfirm{{ u.id }}', this)">
                        <i class="fa fa-eye"></i>
                      </button>
                    </div>
                  </div>

                  <div class="modal-footer border-0">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Zrušiť</button>
                    <button type="submit" class="btn btn-warning">Uložiť</button>
                  </div>
                </form>
              </div>
            </div>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
  {% else %}
  <div class="alert alert-info">Žiadni používatelia neboli nájdení.</div>
  {% endif %}
</div>

<script>
function togglePassword(id, btn) {
  const input = document.getElementById(id);
  const icon = btn.querySelector('i');
  if (input.type === "password") {
    input.type = "text";
    icon.classList.replace('fa-eye', 'fa-eye-slash');
  } else {
    input.type = "password";
    icon.classList.replace('fa-eye-slash', 'fa-eye');
  }
}
</script>
{% endblock %}
