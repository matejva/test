{% extends 'base.html' %}
{% block content %}
<style>
/* üí° Fix proti preblik√°vaniu */
.modal,
.modal-dialog,
.modal-content,
.modal-backdrop {
  transition: none !important;
  animation: none !important;
}
.modal-backdrop.show {
  opacity: 0.3 !important;
}
body.modal-open {
  overflow: hidden !important;
  padding-right: 0 !important;
  filter: none !important;
  backdrop-filter: none !important;
  transform: none !important;
}
.card.user-card {
  transition: none !important;
  transform: none !important;
  box-shadow: none !important;
}
</style>

<div class="container-fluid">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h3 class="fw-bold mb-0">Pou≈æ√≠vatelia</h3>
    {% if user.is_admin %}
    <!-- Prida≈• pou≈æ√≠vateƒæa m√¥≈æu len admini -->
    <a href="{{ url_for('create_user') }}" class="btn btn-primary">
      <i class="fa fa-user-plus me-2"></i> Prida≈• pou≈æ√≠vateƒæa
    </a>
    {% endif %}
  </div>

  {% if users %}
  <div class="row">
    {% for u in users %}
    <div class="col-md-4 col-lg-3 mb-4">
      <div class="card user-card shadow-sm text-center p-3" style="cursor: default;">
        <div class="card-body">
          <div class="avatar-circle bg-gradient mb-3">
            <span class="initials">{{ u.name[:2]|upper }}</span>
          </div>

          <h5 class="fw-bold mb-1">{{ u.name }}</h5>
          <p class="text-muted mb-2 small">{{ u.email or 'Bez e-mailu' }}</p>

          {% if u.is_admin %}
            <span class="badge bg-success px-3 py-2">Admin</span>
          {% else %}
            <span class="badge bg-secondary px-3 py-2">Pou≈æ√≠vateƒæ</span>
          {% endif %}

          <!-- üü° Zmena hesla -->
          {% if user.is_admin or user.id == u.id %}
          <button type="button" class="btn btn-warning btn-sm mt-3"
                  data-bs-toggle="modal"
                  data-bs-target="#changePassModal{{ u.id }}">
            <i class="fa fa-key me-1"></i>
            {% if user.id == u.id and not user.is_admin %}
              Zmeni≈• svoje heslo
            {% else %}
              Zmeni≈• heslo
            {% endif %}
          </button>
          {% endif %}

          <!-- üîπ Admin akcie -->
          {% if user.is_admin %}
          <div class="d-flex justify-content-center gap-2 mt-3">
            <a href="{{ url_for('edit_user', user_id=u.id) }}" class="btn btn-outline-primary btn-sm" title="Upravi≈•">
              <i class="fa fa-pen"></i>
            </a>
            {% if not u.is_admin %}
            <form method="POST" action="{{ url_for('delete_user', user_id=u.id) }}"
                  onsubmit="return confirm('Naozaj chce≈° vymaza≈• pou≈æ√≠vateƒæa {{ u.name }}?');" style="display:inline;">
              <button type="submit" class="btn btn-outline-danger btn-sm" title="Vymaza≈•">
                <i class="fa fa-trash"></i>
              </button>
            </form>
            {% endif %}
          </div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Modal na zmenu hesla -->
    {% if user.is_admin or user.id == u.id %}
    <div class="modal" id="changePassModal{{ u.id }}" tabindex="-1"
         aria-labelledby="changePassLabel{{ u.id }}" aria-hidden="true"
         data-bs-backdrop="static">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <form method="POST" action="{{ url_for('change_password', user_id=u.id) }}">
            <div class="modal-header border-0">
              <h5 class="modal-title">
                <i class="fa fa-key me-2 text-warning"></i>
                {% if user.id == u.id and not user.is_admin %}
                  Zmeni≈• svoje heslo
                {% else %}
                  Zmena hesla pre {{ u.name }}
                {% endif %}
              </h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
              <label class="form-label">Nov√© heslo</label>
              <div class="input-group mb-3">
                <input type="password" name="new_password" class="form-control" required minlength="4"
                       placeholder="Zadaj nov√© heslo" id="passwordInput{{ u.id }}">
                <button class="btn btn-outline-secondary" type="button"
                        onclick="togglePassword('passwordInput{{ u.id }}', this)">
                  <i class="fa fa-eye"></i>
                </button>
              </div>

              <label class="form-label">Zopakuj heslo</label>
              <div class="input-group">
                <input type="password" name="confirm_password" class="form-control" required minlength="4"
                       placeholder="Zopakuj nov√© heslo" id="passwordConfirm{{ u.id }}">
                <button class="btn btn-outline-secondary" type="button"
                        onclick="togglePassword('passwordConfirm{{ u.id }}', this)">
                  <i class="fa fa-eye"></i>
                </button>
              </div>
            </div>

            <div class="modal-footer border-0">
              <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Zru≈°i≈•</button>
              <button type="submit" class="btn btn-warning">Ulo≈æi≈•</button>
            </div>
          </form>
        </div>
      </div>
    </div>
    {% endif %}
    {% endfor %}
  </div>
  {% else %}
  <div class="alert alert-info">≈Ωiadni pou≈æ√≠vatelia neboli n√°jden√≠.</div>
  {% endif %}
</div>

<script>
function togglePassword(id, btn) {
  const input = document.getElementById(id);
  const icon = btn.querySelector('i');
  if (input.type === "password") {
    input.type = "text";
    icon.classList.replace('fa-eye', 'fa-eye-slash');
  } else {
    input.type = "password";
    icon.classList.replace('fa-eye-slash', 'fa-eye');
  }
}
</script>
{% endblock %}
